---
import MainLayout from '../../layouts/MainLayout.astro';
import { createClient } from '@supabase/supabase-js';

// Initialize Supabase client with updated keys
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || 'https://ouqhysemcldamthpuqqq.supabase.co';
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91cWh5c2VtY2xkYW10aHB1cXFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNzIxNTIsImV4cCI6MjA2OTY0ODE1Mn0.m7iBYedWpj2ZTgO0uS1F8920uDCpYoyKzbjjNnhiK68';

const supabase = createClient(supabaseUrl, supabaseAnonKey);

// Fetch published blog articles
let articles: any[] = [];
let error = null;
let showComingSoon = false;

try {
  const { data, error: fetchError } = await supabase
    .from('blog_articles')
    .select('*')
    .eq('status', 'published')
    .order('published_at', { ascending: false })
    .limit(12);

  if (fetchError) {
    console.error('Supabase error:', fetchError);
    // If table doesn't exist, show coming soon instead of error
    if (fetchError.message.includes('does not exist') || fetchError.code === '42P01') {
      showComingSoon = true;
    } else {
      error = fetchError.message;
    }
  } else {
    articles = data || [];
  }
} catch (e) {
  console.error('Error fetching articles:', e);
  showComingSoon = true;
}

// Helper function to format date
function formatDate(dateString: string | null) {
  if (!dateString) return '';
  return new Date(dateString).toLocaleDateString('de-DE', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<MainLayout title="Blog - KI-Insights und Automatisierungs-Tipps | Synclaro">
  <div class="min-h-screen bg-white">
    <!-- Hero Section -->
    <section class="pt-24 pb-16 px-6 lg:px-12">
      <div class="container mx-auto max-w-6xl">
        <div class="text-center mb-12">
          <span class="inline-block px-4 py-2 bg-swiss-orange/10 border-2 border-black text-swiss-orange font-mono text-xs uppercase tracking-widest mb-6 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] opacity-0 animate-[fade-in-up_0.6s_ease-out_0.1s_forwards]">
            BLOG
          </span>

          <h1 class="text-5xl sm:text-6xl lg:text-7xl font-black tracking-tight mb-6 opacity-0 animate-[fade-in-up_0.6s_ease-out_0.2s_forwards]">
            KI-Insights & <span class="text-swiss-orange">Automatisierungs-Tipps</span>
          </h1>

          <p class="text-xl text-gray-600 max-w-3xl mx-auto opacity-0 animate-[fade-in-up_0.6s_ease-out_0.3s_forwards]">
            Entdecken Sie wertvolle Einblicke zur KI-Integration, Workflow-Automatisierung und digitalen Transformation für Ihr Unternehmen.
          </p>
        </div>
      </div>
    </section>

    <!-- Articles Grid -->
    <section class="pb-20 px-6 lg:px-12">
      <div class="container mx-auto max-w-6xl">
        {error && (
          <div class="text-center py-12 bg-red-50 border-2 border-black p-8 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
            <p class="text-red-600 font-bold">{error}</p>
            <p class="text-gray-600 mt-2">Bitte versuchen Sie es später erneut.</p>
          </div>
        )}

        {showComingSoon && (
          <div class="reveal text-center py-16 bg-gray-50 border-2 border-black p-8 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all duration-300 hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] hover:-translate-x-1 hover:-translate-y-1">
            <div class="w-20 h-20 bg-swiss-orange border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] mx-auto mb-6 flex items-center justify-center">
              <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <h3 class="text-2xl font-black text-black mb-3">Blog kommt bald!</h3>
            <p class="text-gray-600 text-lg mb-6 max-w-lg mx-auto">
              Wir arbeiten gerade an spannenden Inhalten rund um KI, Automatisierung und digitale Transformation.
            </p>
            <a
              href="/kontakt"
              class="inline-block px-6 py-3 bg-swiss-orange text-white font-bold border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:-translate-x-0.5 hover:-translate-y-0.5 active:shadow-none active:translate-x-1 active:translate-y-1 transition-all duration-150"
            >
              Benachrichtigt werden
            </a>
          </div>
        )}

        {!error && !showComingSoon && articles.length === 0 && (
          <div class="text-center py-12 bg-gray-50 border-2 border-black p-8 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
            <p class="text-gray-600 text-lg font-bold">Noch keine Artikel verfügbar.</p>
            <p class="text-gray-500 mt-2">Schauen Sie bald wieder vorbei!</p>
          </div>
        )}

        {!error && !showComingSoon && articles.length > 0 && (
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {articles.map((article) => (
              <a href={`/blog/${article.slug}`} class="group">
                <article class="h-full bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] hover:-translate-x-1 hover:-translate-y-1 transition-all duration-200 overflow-hidden">
                  <!-- Featured Image -->
                  {article.featured_image && (
                    <div class="h-48 overflow-hidden border-b-2 border-black">
                      <img
                        src={article.featured_image}
                        alt={article.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      />
                    </div>
                  )}
                  {!article.featured_image && (
                    <div class="h-48 bg-gray-100 border-b-2 border-black flex items-center justify-center">
                      <svg class="w-16 h-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                      </svg>
                    </div>
                  )}

                  <div class="p-6">
                    <!-- Meta -->
                    <div class="flex items-center gap-4 text-sm text-gray-500 mb-4">
                      <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        {formatDate(article.published_at || article.created_at)}
                      </span>
                      {article.reading_time && (
                        <span class="flex items-center gap-1">
                          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          {article.reading_time} Min.
                        </span>
                      )}
                    </div>

                    <!-- Title -->
                    <h2 class="text-xl font-black text-black mb-3 group-hover:text-swiss-orange transition-colors">
                      {article.title}
                    </h2>

                    <!-- Excerpt -->
                    <p class="text-gray-600 mb-4 line-clamp-3">
                      {article.excerpt || article.meta_description}
                    </p>

                    <!-- Tags -->
                    {article.tags && article.tags.length > 0 && (
                      <div class="flex flex-wrap gap-2 mb-4">
                        {article.tags.slice(0, 3).map((tag: string) => (
                          <span class="px-2 py-1 bg-gray-100 border border-black text-xs font-mono">
                            {tag}
                          </span>
                        ))}
                      </div>
                    )}

                    <!-- Read more -->
                    <div class="flex items-center text-swiss-orange font-bold">
                      <span>Artikel lesen</span>
                      <svg class="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                      </svg>
                    </div>
                  </div>
                </article>
              </a>
            ))}
          </div>
        )}
      </div>
    </section>

    <!-- CTA Section -->
    <section class="py-20 px-6 lg:px-12 bg-swiss-orange">
      <div class="container mx-auto max-w-4xl text-center">
        <h2 class="reveal text-4xl lg:text-5xl font-black text-white mb-6">
          Bleiben Sie auf dem Laufenden
        </h2>
        <p class="reveal text-xl text-white/90 mb-8">
          Erhalten Sie die neuesten KI-Insights direkt in Ihr Postfach.
        </p>
        <a
          href="/kontakt"
          class="reveal inline-block bg-black text-white font-bold px-8 py-4 border-2 border-black shadow-[4px_4px_0px_0px_rgba(255,255,255,0.3)] hover:shadow-[8px_8px_0px_0px_rgba(255,255,255,0.3)] hover:-translate-x-1 hover:-translate-y-1 transition-all duration-300"
        >
          Jetzt informieren
        </a>
      </div>
    </section>
  </div>
</MainLayout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
